<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ノート一覧</title>
    <style>
        #hyou:hover {
            background-color: #f0f4ff;
            cursor: pointer;
        }
    </style>
</head>
<body style="margin: 0; padding: 0;">
    <div style="max-width: 90%; margin: 0 auto; padding: 0 32px; box-sizing: border-box;">
        <h1>ノート一覧</h1>
        <!-- 検索フォーム -->
        <form method="post" style="display: flex; align-items: center; width: 100%; box-sizing: border-box; position: relative;">
            <!-- 検索入力欄 -->
            <input type="text" id="searchword" name="searchword" placeholder="ノートを検索（タイトル・内容）" value="{{ searchword }}";
                style="width: 30%; min-width: 150px; max-width: 50%; font-size: 1.2em; padding-right: 2em;"
                oninput="clearbutton()">
            <!-- 入力クリアボタン -->
            <button type="button" id="clear-btn" onclick="clearsearch()"
                style="display: none; position: absolute; right: 68%; top: 50%; transform: translateY(-50%); border: none; background: transparent; font-size: 1.2em; cursor: pointer;">✕</button>
            <!-- 検索ボタン -->
            <button type="submit" style="font-size: 1.0em; margin-left: 1%;">🔍</button>
            <!-- 並び順プルダウン -->
            <select name="order" style="margin-left: 2%; font-size: 1.0em;" onchange="this.form.submit()">
                {% for o in orders %}
                    <option value="{{ o }}" {% if o == order %}selected{% endif %}>{{ o }}</option>
                {% endfor %}
            </select>
            <!-- 右寄せ用スペース -->
            <span style="flex: 1;"></span>
            <!-- 新規ノート作成ボタン -->
            <button type="button" style="font-size: 1.0em; margin-right: 10%;" onclick="location.href='/note'">＋ 新規ノート</button>
        </form>
        <!-- ノート件数表示 -->
        <p style="margin: 8px 0 0 0;">
            {{ len }}件のノート
        </p>
        {% if notes %}
        <!-- ノート一覧テーブル -->
        <table style="border: none; margin-top: 24px; width: 100%; border-collapse: collapse;" cellpadding="8" cellspacing="0">
            <thead>
                <tr>
                    <!-- タイトル列 -->
                    <th style="text-align: left;">タイトル</th>
                    <!-- 最終更新日列 -->
                    <th style="text-align: left;">最終更新日</th>
                    <!-- 操作列 -->
                    <th></th>
                </tr>
            </thead>
            <today>
            {% for note in notes: %}
            <tr id="hyou" onclick="location.href='/note'">
                    <td style="text-align: left;" >{{ note.title }}</td>
                    <td style="text-align: left;">{{ note.date }}</td>
                    <td style="text-align: center;">
                        <!-- ノート一覧テーブル内の削除ボタン -->
                        <button type="button"
                            onclick="confirmDeleteCustom('{{ note.id }}', '{{ note.title|e }}')"
                            style="font-size: 1.0em;">🗑️</button>
                    </td>
            </tr>
            {% endfor %}
            </today>
        </table>
        {% endif %}
        <!-- ノートがない場合のメッセージ -->
        {% if not notes %}
            <p style="text-align: center; color: #999; margin-top: 24px;">ノートがありません</p>
        {% endif %}
    </div>

    <!-- 削除確認モーダル -->
    <div id="custom-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); min-width:260px; text-align:center;">
            <!-- モーダルタイトル -->
            <p style="margin-bottom: 24px; text-align: left;">ノートを削除しますか？</p>
            <!-- モーダル説明 -->
            <p style="margin-bottom: 32px; color:#666;">
                「<span id="modal-note-title"></span>」を削除します。この操作は元に戻せません。
            </p>
            <!-- キャンセルボタン -->
            <button onclick="closeModal(false)" style="padding:8px 24px; background:#ccc; color:#333; border:none; border-radius:4px; font-size:1em; cursor:pointer;">キャンセル</button>
            <!-- 削除ボタン -->
            <button onclick="closeModal(true)" style="margin-right:16px; padding:8px 24px; background:#d32f2f; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;">削除</button>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" style="display:none; position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background:#323232; color:#fff; padding:16px 32px; border-radius:8px; font-size:1.1em; z-index:2000; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
        削除しました
    </div>

    <script>
    function clearbutton(){
        const searchWord = document.getElementById('searchword').value;
        document.getElementById('clear-btn').style.display = searchWord ? 'block' : 'none';
    }

    function clearsearch() {
        document.getElementById('searchword').value = '';
        clearbutton();
        document.querySelector('form').submit(); //空にして送信
    }
    
    // 削除時のコールバックを保持
    let deleteCallback = null;

    // 削除確認モーダルを表示
    function confirmDeleteCustom(id, title) {
        document.getElementById('custom-modal').style.display = 'flex';
        document.getElementById('modal-note-title').textContent = title;
        deleteCallback = function() {
            fetch('/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'id=' + encodeURIComponent(id)
            }).then(() => {
                location.reload();
            });
        };
    }

    // モーダルを閉じる・削除処理実行
    function closeModal(doDelete) {
        document.getElementById('custom-modal').style.display = 'none';
        if (doDelete && typeof deleteCallback === 'function') {
            deleteCallback();
            showToast('削除しました');
        }
        deleteCallback = null;
    }

    // トースト表示関数
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }
    clearbutton();
    
    </script>
</body>
</html>