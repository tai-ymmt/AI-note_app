<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ノート一覧</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    

    <!-- 以下、ノート一覧画面 -->
    {% include "header.html" %}
</head>
<body style="margin: 0; padding: 0;">
    <div style="max-width: 90%; margin: 0 auto; padding: 0 32px; box-sizing: border-box;">
        <h1>ノート一覧</h1>
        <!-- 検索フォーム -->
        <form method="post" style="display: flex; align-items: center; width: 100%; box-sizing: border-box; position: relative;">
            <!-- 検索入力欄 -->
            <input type="text" class="ichiran-search-input" id="searchword" name="searchword" placeholder="ノートを検索（タイトル・内容）" value="{{ searchword }}";
                style="width: 40%; min-width: 150px; max-width: 50%; font-size: 1.2em; padding-right: 2em; background-color: #fff;"
                oninput="clearbutton()">
            <!-- 入力クリアボタン -->
            <button type="button" id="clear-btn" onclick="clearsearch()"
                style="display: none; position: absolute; right: 56%; top: 50%; transform: translateY(-50%); border: none; background: transparent; font-size: 1.2em; cursor: pointer;">✕</button>
            <!-- 検索ボタン -->
            <button type="submit" class="ichiran-search-btn" style="font-size: 1.0em; margin-left: 1%;"><i class="fas fa-search"></i></button>
            <!-- 並び順プルダウン -->
            <select name="order" class="modal-select" style="margin-left: 2%; font-size: 1.0em; background-color: #fff" onchange="this.form.submit()">
                {% for o in orders %}
                    <option value="{{ o }}" {% if o == order %}selected{% endif %}>{{ o }}</option>
                {% endfor %}
            </select>
            <!-- 右寄せ用スペース -->
            <span style="flex: 1;"></span>
            <!-- 新規ノート作成ボタン -->
            <button type="button" id="create-note-btn" class="btn btn-save" style="font-size: 1.0em; margin-right: 0%;">＋ 新規ノート</button>
        </form>
        <!-- ノート件数表示 -->
        <p style="margin: 8px 0 0 0;">
            {{ len }}件のノート
        </p>
        {% if len>0 %}
        <!-- ノート一覧テーブル -->
        <table class="hyou-section" style="border: none; margin-top: 24px; width: 100%; border-collapse: collapse;" cellpadding="8" cellspacing="0">
           <thead>
                <tr>
                    <!-- タイトル列 -->
                    <th style="text-align: left; padding-left: 5%; width: 45ch;">タイトル</th>
                    <!-- 最終更新日列 -->
                    <th style="text-align: left;">最終更新日</th>
                    <!-- 操作列 -->
                    <th style="width: 15%;"></th>
                </tr>
            </thead>
            <tbody>
                {% for note in notes: %}
                <tr id="hyou" onclick="location.href='/note/{{ note.num }}'">
                    <!-- ノートタイトル -->
                    <td style="text-align: left; padding-left: 5%; width: 45ch;">{{ note.title }}</td>
                    <!-- 最終更新日　xxxx年xx月xx日 -->
                    <td style="text-align: left;">{{ note.update_time.strftime('%Y年%m月%d日') }}</td>
                    <!-- ノート一覧テーブル内の削除ボタン -->
                    <td style="text-align: left; width: 1%;">
                        <button type="button"
                            onclick="event.stopPropagation(); confirmDeleteCustom('{{ note.num }}', '{{ note.title|e }}')"
                            class="btn btn-delete" style="font-size: 1.0em;"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% endif %}
        <!-- ノートがない場合のメッセージ -->
        {% if len==0 %}
            <p style="text-align: center; color: #999; margin-top: 24px;">ノートがありません</p>
        {% endif %}
    </div>

    <!-- 削除確認モーダル -->
        <div id="remove-confirm-modal" class="modal-outer">
        <div class="modal-inner">
        <div class="modal-header">
            <span class="modal-title" style="color: #d64242;"><i class="fas fa-exclamation-triangle"></i> ノートを削除</span>
        </div>
        <div class="modal-body">
            <p style="margin: 1em 0 2em; line-height: 1.6;">
            本当に「<span id="modal-note-title"></span>」を削除しますか？<br>この操作は元に戻すことはできません。
            </p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeModal(false)" class="btn btn-ghost" id="cancel-delete-btn">キャンセル</button>
            <button type="button" onclick="closeModal(true)" class="btn btn-delete" id="confirm-remove-btn">削除する</button>
        </div>
        </div>
    </div>
  
   <!-- トースト通知 -->
    <div id="toast"></div>

    <script>
    // 新規ノート作成ボタンのクリックイベント（この関数は削除して山本くんのやつに合わせるのがいい）
    document.getElementById('create-note-btn').addEventListener('click', function() {
      fetch('/note/create', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          // 作成後、そのノートの編集画面へ移動
          window.location.href = '/note/' + data.note_id;
        });
    });

    // 検索欄の入力クリアボタンの表示制御
    function clearbutton(){
        const searchWord = document.getElementById('searchword').value;
        document.getElementById('clear-btn').style.display = searchWord ? 'block' : 'none';
    }

    // 検索欄の入力クリアボタンをクリックしたときの処理
    function clearsearch() {
        document.getElementById('searchword').value = '';
        clearbutton();
        document.querySelector('form').submit(); //空にして送信
    }

    // ページ読み込み時に検索欄の入力クリアボタンの表示状態を更新
    clearbutton();
   
    // 削除確認モーダルを表示
    function confirmDeleteCustom(id, title) {
        console.log("削除確認モーダルを表示");
        document.getElementById('remove-confirm-modal').style.display = 'flex';
        document.getElementById('modal-note-title').textContent = title;
        document.getElementById('confirm-remove-btn').onclick = function() {
            fetch('/remove', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'id=' + encodeURIComponent(id)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message); });
                }
                return response.json();
            }).then(data => {
                setTimeout(() => window.location.reload(), 1200); // 画面を更新
                showToast(data.message || '削除しました');
                }).catch(error => {
                console.error('Error:', error);
                showToast(error.message);
            });
            closeModal();
        };
    }

    // 削除確認モーダルを閉じる
    function closeModal() {
        document.getElementById('remove-confirm-modal').style.display = 'none';
    }

    // トースト通知の要素
    const toast = document.getElementById('toast');
    let toastTimer = null;

    // トースト通知を表示
    function showToast(message) {
        if (toastTimer) clearTimeout(toastTimer);
        toast.textContent = message;
        toast.classList.add('is-visible');
        toastTimer = setTimeout(() => {
            toast.classList.remove('is-visible');
        }, 2500);
    }
    
    </script>
